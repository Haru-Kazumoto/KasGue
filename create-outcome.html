<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KasGue | Create</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-50 text-gray-800" id="app">


    <!-- Sticky red navbar (Tailwind + Flowbite) -->
    <nav class="sticky top-0 z-50 bg-red-600 border-red-700/10 shadow-sm">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <div class="flex items-center space-x-3 rtl:space-x-reverse">
                <span class="self-center text-2xl font-bold whitespace-nowrap text-white">KasGue</span>
            </div>

            <div class="flex items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
                <button type="button"
                    class="flex text-sm bg-white/10 hover:bg-white/20 rounded-full md:me-0 focus:ring-4 focus:ring-white/30"
                    id="user-menu-button" aria-expanded="false" data-dropdown-toggle="user-dropdown"
                    data-dropdown-placement="bottom">
                    <span class="sr-only">Open user menu</span>
                    <img class="w-8 h-8 rounded-full"
                        src="https://static.vecteezy.com/system/resources/thumbnails/020/429/953/small_2x/admin-icon-vector.jpg"
                        alt="user photo">
                </button>

                <!-- Dropdown menu -->
                <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow-sm"
                    id="user-dropdown">
                    <div class="px-4 py-3">
                        <span class="block text-sm text-gray-900">{{ current_user.fullname }}</span>
                        <span class="block text-sm text-gray-500 truncate">{{ current_user.email }}</span>
                    </div>
                    <ul class="py-2" aria-labelledby="user-menu-button">
                        <li><a href="#" @click="logout"
                                class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Sign out</a></li>
                    </ul>
                </div>

                <button data-collapse-toggle="navbar-user" type="button"
                    class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white rounded-lg md:hidden hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/30"
                    aria-controls="navbar-user" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 17 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M1 1h15M1 7h15M1 13h15" />
                    </svg>
                </button>
            </div>

            <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-user">
                <ul
                    class="flex flex-col font-medium p-4 md:p-0 mt-4 border border-red-200/30 rounded-lg bg-red-500 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent">
                    <li>
                        <a href="dashboard.html" class="block py-2 px-3 text-white rounded-sm 
                            md:text-white md:p-0 md:font-semibold" aria-current="page">
                            Home
                        </a>
                    </li>

                    <li>
                        <a href="income.html" class="block py-2 px-3 text-white bg-red-700 rounded-sm 
                            md:bg-transparent md:text-white md:p-0 
                            md:border-b-2 md:border-white md:font-semibold" aria-current="page">
                            Pembayaran
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="block py-2 px-3 text-white/90 rounded-sm hover:bg-red-500 md:hover:bg-transparent md:hover:text-white md:p-0">Pengeluaran</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Wrapper: responsive padding + centered container -->
    <div class="flex flex-col min-h-full px-4 sm:px-6 lg:px-12 xl:px-16 py-5">
        <div class="w-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-5 gap-3 md:gap-4">
            <!-- Kolom kiri -->
            <div class="md:col-span-2">
                <!-- KOSONG -->
            </div>

            <!-- Kolom kanan (konten) -->
            <div class="md:col-span-3">
                <div
                    class="border border-gray-200 bg-white rounded-2xl p-4 sm:p-6 shadow gap-4 flex flex-wrap justify-between items-center">
                    <button type="button" @click="backRoute" class="text-red-700 hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none 
                        focus:ring-red-300 font-medium rounded-lg text-sm px-2 py-1 text-center ">
                        Kembali
                    </button>

                    <span class="text-xl font-bold">Pengeluaran Baru</span>
                </div>
                <div id="tooltip-default" role="tooltip"
                    class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                    Buat Data Baru
                    <div class="tooltip-arrow" data-popper-arrow></div>
                </div>

                <div
                    class="mt-3 border border-gray-200 bg-white rounded-2xl p-4 shadow-sm min-h-[160px] flex flex-col gap-3">

                    <!-- Alert -->
                    <div v-if="formError" class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3">
                        {{ formError }}
                    </div>
                    <div v-if="formSuccess"
                        class="text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg p-3">
                        {{ formSuccess }}
                    </div>

                    <form class="grid grid-cols-1 md:grid-cols-2 gap-4" @submit.prevent="submitPayment">

                        <!-- Nama Pembayar -->
                        <div class="flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-700">Judul Pengeluaran<span
                                    class="text-red-600">*</span></label>
                            <input v-model.trim="paymentForm.payer_name" type="text" required
                                placeholder="Beli Truck"
                                @input="paymentForm.payer_name = paymentForm.payer_name.toUpperCase()"
                                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500" />

                        </div>

                        <!-- Jumlah (Rp) -->
                        <div class="flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-700">Jumlah (Rp) <span
                                    class="text-red-600">*</span></label>
                            <input v-model.trim="paymentForm.amount_raw" inputmode="numeric" pattern="[0-9]*" required
                                placeholder="Contoh: 150000"
                                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500" />
                            <p class="text-xs text-gray-500">Preview: <span class="font-medium">{{ amountFormatted
                                    }}</span></p>
                        </div>

                        <!-- Metode Pembayaran -->
                        <div class="flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-700">Metode Penarikan<span
                                    class="text-red-600">*</span></label>
                            <select v-model="paymentForm.method" required
                                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500">
                                <option disabled value="">Pilih metode…</option>
                                <option value="CASH">Tunai (Cash)</option>
                                <option value="BANK_TRANSFER">Transfer Bank</option>
                                <option value="EWALLET">E-Wallet</option>
                                <option value="QRIS">QRIS</option>
                            </select>
                        </div>

                        <!-- Tipe Pembayaran -->
                        <div class="flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-700">Tipe Pengeluaran<span
                                    class="text-red-600">*</span></label>
                            <select v-model="paymentForm.type" required
                                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500">
                                <option disabled value="">Pilih tipe…</option>
                                <option value="KAS">KAS</option>
                                <option value="LAINNYA">Lainnya</option>
                            </select>
                        </div>
                        <!-- Keterangan -->
                        <div class="flex flex-col gap-1 md:col-span-2">
                            <label class="text-sm font-medium text-gray-700">Keterangan</label>
                            <textarea v-model.trim="paymentForm.notes" rows="3" placeholder="Catatan tambahan…"
                                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500"></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
                            <button type="button" @click="backRoute"
                                class="text-gray-700 hover:text-white border border-gray-300 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-2">
                                Batal
                            </button>
                            <button type="submit" :disabled="submitting"
                                class="text-white bg-red-600 hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2">
                                <span v-if="!submitting">Simpan</span>
                                <span v-else>Menyimpan…</span>
                            </button>
                        </div>
                    </form>

                </div>

            </div>
        </div>
    </div>
    <!-- Vue 3 CDN (global build) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue

        // Kalau sudah ada app, gabungkan saja bagian setup-nya.
        // Di bawah ini contoh lengkap:
        createApp({
            setup() {
                const current_user = ref({});

                onMounted(() => {
                    try {
                        const cached = localStorage.getItem("user_data");
                        if (cached) current_user.value = JSON.parse(cached);
                    } catch (e) {
                        console.error("Gagal parse user dari localStorage", e)
                    }
                })

                // --- STATE FORM ---
                const paymentForm = ref({
                    payer_name: '',
                    amount_raw: '',   // angka mentah string, mis: "150000"
                    paid_at: '',      // format YYYY-MM-DD
                    method: '',
                    type: '',
                    status: 'OUTCOME',
                    reference: '',
                    notes: '',
                })

                const submitting = ref(false)
                const formError = ref('')
                const formSuccess = ref('')

                // --- UTIL ---
                const toNumber = (s) => Number(String(s).replace(/[^\d]/g, '')) || 0
                const amountFormatted = computed(() =>
                    new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 })
                        .format(toNumber(paymentForm.value.amount_raw))
                )

                // set default Tanggal = hari ini
                onMounted(() => {
                    if (!paymentForm.value.paid_at) {
                        const d = new Date()
                        const yyyy = d.getFullYear()
                        const mm = String(d.getMonth() + 1).padStart(2, '0')
                        const dd = String(d.getDate()).padStart(2, '0')
                        paymentForm.value.paid_at = `${yyyy}-${mm}-${dd}`
                    }
                })

                // --- CONFIG API ---
                const API_BASE = "https://kasgue-backend-production.up.railway.app/api/v1"
                // const API_BASE = "http://localhost:3000/api/v1"

                // --- ACTIONS ---
                const submitPayment = async () => {
                    formError.value = ''
                    formSuccess.value = ''
                    submitting.value = true
                    try {
                        // validasi sederhana
                        if (!paymentForm.value.payer_name) throw new Error('Nama pembayar wajib diisi')
                        const amount = toNumber(paymentForm.value.amount_raw)
                        if (amount <= 0) throw new Error('Jumlah harus lebih dari 0')
                        if (!paymentForm.value.paid_at) throw new Error('Tanggal bayar wajib diisi')
                        if (!paymentForm.value.method) throw new Error('Metode pembayaran wajib dipilih')
                        if (!paymentForm.value.type) throw new Error('Tipe pembayaran wajib dipilih')

                        // payload ke backend (sesuaikan field sesuai API kamu)
                        const payload = {
                            payer_name: paymentForm.value.payer_name,
                            amount: amount,                          // kirim angka murni
                            paid_at: paymentForm.value.paid_at,      // "YYYY-MM-DD"
                            method: paymentForm.value.method,
                            type: paymentForm.value.type,
                            status: paymentForm.value.status,
                            reference: paymentForm.value.reference || null,
                            notes: paymentForm.value.notes || null,
                            username: current_user.value.username
                        }

                        const res = await fetch(`${API_BASE}/payments/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include', // penting untuk session cookie
                            body: JSON.stringify(payload),
                        })

                        const contentType = res.headers.get('content-type') || ''
                        const data = contentType.includes('application/json') ? await res.json() : await res.text()

                        if (!res.ok) {
                            const msg = typeof data === 'string' ? data : (data.message || 'Gagal menyimpan pembayaran')
                            throw new Error(msg)
                        }

                        formSuccess.value = "Oke berhasil, bentar gw simpen dulu...";

                        // Reset form (opsional)
                        paymentForm.value = {
                            payer_name: '',
                            amount_raw: '',
                            paid_at: paymentForm.value.paid_at, // tetap hari ini
                            method: '',
                            type: '',
                            status: 'OUTCOME',
                            reference: '',
                            notes: '',
                        }

                        setInterval(() => {
                            window.location.href = 'outcome.html';
                        }, 2000);
                    } catch (e) {
                        formError.value = e?.message
                    } finally {
                        submitting.value = false
                    }
                }

                // tombol "Kembali" (kamu sudah punya @click=backRoute)
                const backRoute = () => history.length > 1 ? history.back() : (window.location.href = 'dashboard.html')

                // RETURN ke template
                return {
                    paymentForm,
                    submitting,
                    formError,
                    formSuccess,
                    amountFormatted,
                    submitPayment,
                    backRoute,
                    current_user
                }
            }
        }).mount('#app')
    </script>


</body>

</html>